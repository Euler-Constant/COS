#include "font.h"

// Implementation of font8x8_basic, draw_char, draw_string, framebuffer_log_init, framebuffer_log_write, etc.

static const unsigned char font8x8_basic[96][8] = {
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // 32  
    {0x18,0x3c,0x3c,0x18,0x18,0x00,0x18,0x00}, // 33  !
    {0x6c,0x6c,0x24,0x00,0x00,0x00,0x00,0x00}, // 34  "
    {0x6c,0x6c,0xfe,0x6c,0xfe,0x6c,0x6c,0x00}, // 35  #
    {0x18,0x3e,0x60,0x3c,0x06,0x7c,0x18,0x00}, // 36  $
    {0x00,0xc6,0xcc,0x18,0x30,0x66,0xc6,0x00}, // 37  %
    {0x38,0x6c,0x38,0x76,0xdc,0xcc,0x76,0x00}, // 38  &
    {0x18,0x18,0x30,0x00,0x00,0x00,0x00,0x00}, // 39  '
    {0x0c,0x18,0x30,0x30,0x30,0x18,0x0c,0x00}, // 40  (
    {0x30,0x18,0x0c,0x0c,0x0c,0x18,0x30,0x00}, // 41  )
    {0x00,0x66,0x3c,0xff,0x3c,0x66,0x00,0x00}, // 42  *
    {0x00,0x18,0x18,0x7e,0x18,0x18,0x00,0x00}, // 43  +
    {0x00,0x00,0x00,0x00,0x18,0x18,0x30,0x00}, // 44  ,
    {0x00,0x00,0x00,0x7e,0x00,0x00,0x00,0x00}, // 45  -
    {0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00}, // 46  .
    {0x06,0x0c,0x18,0x30,0x60,0xc0,0x80,0x00}, // 47  /
    {0x3c,0x66,0x6e,0x7e,0x76,0x66,0x3c,0x00}, // 48  0
    {0x18,0x38,0x18,0x18,0x18,0x18,0x7e,0x00}, // 49  1
    {0x3c,0x66,0x06,0x0c,0x18,0x30,0x7e,0x00}, // 50  2
    {0x3c,0x66,0x06,0x1c,0x06,0x66,0x3c,0x00}, // 51  3
    {0x0c,0x1c,0x3c,0x6c,0xfe,0x0c,0x0c,0x00}, // 52  4
    {0x7e,0x60,0x7c,0x06,0x06,0x66,0x3c,0x00}, // 53  5
    {0x1c,0x30,0x60,0x7c,0x66,0x66,0x3c,0x00}, // 54  6
    {0x7e,0x66,0x0c,0x18,0x18,0x18,0x18,0x00}, // 55  7
    {0x3c,0x66,0x66,0x3c,0x66,0x66,0x3c,0x00}, // 56  8
    {0x3c,0x66,0x66,0x3e,0x06,0x0c,0x38,0x00}, // 57  9
    {0x00,0x18,0x18,0x00,0x18,0x18,0x00,0x00}, // 58  :
    {0x00,0x18,0x18,0x00,0x18,0x18,0x30,0x00}, // 59  ;
    {0x0e,0x1c,0x38,0x70,0x38,0x1c,0x0e,0x00}, // 60  <
    {0x00,0x00,0x7e,0x00,0x7e,0x00,0x00,0x00}, // 61  =
    {0x70,0x38,0x1c,0x0e,0x1c,0x38,0x70,0x00}, // 62  >
    {0x3c,0x66,0x0c,0x18,0x18,0x00,0x18,0x00}, // 63  ?
    {0x3c,0x66,0x6e,0x6a,0x6e,0x60,0x3c,0x00}, // 64  @
    {0x18,0x24,0x42,0x7e,0x42,0x42,0x42,0x00}, // 65  A
    {0x7c,0x42,0x42,0x7c,0x42,0x42,0x7c,0x00}, // 66  B
    {0x3c,0x42,0x40,0x40,0x40,0x42,0x3c,0x00}, // 67  C
    {0x78,0x44,0x42,0x42,0x42,0x44,0x78,0x00}, // 68  D
    {0x7e,0x40,0x40,0x7c,0x40,0x40,0x7e,0x00}, // 69  E
    {0x7e,0x40,0x40,0x7c,0x40,0x40,0x40,0x00}, // 70  F
    {0x3c,0x42,0x40,0x4e,0x42,0x42,0x3c,0x00}, // 71  G
    {0x42,0x42,0x42,0x7e,0x42,0x42,0x42,0x00}, // 72  H
    {0x3c,0x18,0x18,0x18,0x18,0x18,0x3c,0x00}, // 73  I
    {0x1e,0x0c,0x0c,0x0c,0x0c,0x4c,0x38,0x00}, // 74  J
    {0x42,0x44,0x48,0x70,0x48,0x44,0x42,0x00}, // 75  K
    {0x40,0x40,0x40,0x40,0x40,0x40,0x7e,0x00}, // 76  L
    {0x42,0x66,0x5a,0x5a,0x42,0x42,0x42,0x00}, // 77  M
    {0x42,0x62,0x52,0x4a,0x46,0x42,0x42,0x00}, // 78  N
    {0x3c,0x42,0x42,0x42,0x42,0x42,0x3c,0x00}, // 79  O
    {0x7c,0x42,0x42,0x7c,0x40,0x40,0x40,0x00}, // 80  P
    {0x3c,0x42,0x42,0x42,0x4a,0x44,0x3a,0x00}, // 81  Q
    {0x7c,0x42,0x42,0x7c,0x48,0x44,0x42,0x00}, // 82  R
    {0x3c,0x42,0x40,0x3c,0x02,0x42,0x3c,0x00}, // 83  S
    {0x7e,0x18,0x18,0x18,0x18,0x18,0x18,0x00}, // 84  T
    {0x42,0x42,0x42,0x42,0x42,0x42,0x3c,0x00}, // 85  U
    {0x42,0x42,0x42,0x42,0x42,0x24,0x18,0x00}, // 86  V
    {0x42,0x42,0x42,0x5a,0x5a,0x66,0x42,0x00}, // 87  W
    {0x42,0x24,0x18,0x18,0x18,0x24,0x42,0x00}, // 88  X
    {0x42,0x24,0x18,0x18,0x18,0x18,0x18,0x00}, // 89  Y
    {0x7e,0x04,0x08,0x10,0x20,0x40,0x7e,0x00}, // 90  Z
    {0x3c,0x30,0x30,0x30,0x30,0x30,0x3c,0x00}, // 91  [
    {0xc0,0x60,0x30,0x18,0x0c,0x06,0x02,0x00}, // 92  backslash
    {0x3c,0x0c,0x0c,0x0c,0x0c,0x0c,0x3c,0x00}, // 93  ]
    {0x10,0x38,0x6c,0xc6,0x00,0x00,0x00,0x00}, // 94  ^
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff}, // 95  _
    {0x18,0x18,0x30,0x00,0x00,0x00,0x00,0x00}, // 96  `
    {0x00,0x3c,0x02,0x3e,0x42,0x46,0x3a,0x00}, // 97  a
    {0x40,0x40,0x7c,0x42,0x42,0x42,0x7c,0x00}, // 98  b
    {0x00,0x3c,0x42,0x40,0x40,0x42,0x3c,0x00}, // 99  c
    {0x02,0x02,0x3e,0x42,0x42,0x42,0x3e,0x00}, // 100 d
    {0x00,0x3c,0x42,0x7e,0x40,0x42,0x3c,0x00}, // 101 e
    {0x0e,0x10,0x10,0x3c,0x10,0x10,0x10,0x00}, // 102 f
    {0x00,0x3e,0x42,0x42,0x3e,0x02,0x3c,0x00}, // 103 g
    {0x40,0x40,0x7c,0x42,0x42,0x42,0x42,0x00}, // 104 h
    {0x18,0x00,0x38,0x18,0x18,0x18,0x3c,0x00}, // 105 i
    {0x0c,0x00,0x0c,0x0c,0x0c,0x4c,0x38,0x00}, // 106 j
    {0x40,0x44,0x48,0x70,0x48,0x44,0x42,0x00}, // 107 k
    {0x38,0x18,0x18,0x18,0x18,0x18,0x3c,0x00}, // 108 l
    {0x00,0x66,0x7f,0x5b,0x5b,0x5b,0x5b,0x00}, // 109 m
    {0x00,0x7c,0x42,0x42,0x42,0x42,0x42,0x00}, // 110 n
    {0x00,0x3c,0x42,0x42,0x42,0x42,0x3c,0x00}, // 111 o
    {0x00,0x7c,0x42,0x42,0x7c,0x40,0x40,0x00}, // 112 p
    {0x00,0x3e,0x42,0x42,0x3e,0x02,0x02,0x00}, // 113 q
    {0x00,0x7c,0x42,0x40,0x40,0x40,0x40,0x00}, // 114 r
    {0x00,0x3c,0x40,0x3c,0x02,0x42,0x3c,0x00}, // 115 s
    {0x10,0x10,0x7c,0x10,0x10,0x10,0x0e,0x00}, // 116 t
    {0x00,0x42,0x42,0x42,0x42,0x46,0x3a,0x00}, // 117 u
    {0x00,0x42,0x42,0x42,0x24,0x18,0x18,0x00}, // 118 v
    {0x00,0x42,0x42,0x5a,0x5a,0x66,0x42,0x00}, // 119 w
    {0x00,0x42,0x24,0x18,0x18,0x24,0x42,0x00}, // 120 x
    {0x00,0x42,0x42,0x3e,0x02,0x42,0x3c,0x00}, // 121 y
    {0x00,0x7e,0x04,0x18,0x30,0x60,0x7e,0x00}, // 122 z
    {0x0e,0x18,0x18,0x70,0x18,0x18,0x0e,0x00}, // 123 {
    {0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x00}, // 124 |
    {0x70,0x18,0x18,0x0e,0x18,0x18,0x70,0x00}, // 125 }
    {0x76,0xdc,0x00,0x00,0x00,0x00,0x00,0x00}, // 126 ~
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}  // 127 (DEL)
};

void draw_char(unsigned int* fb, int fb_width, int x, int y, char c, unsigned int color) {
    if ((unsigned char)c < 32 || (unsigned char)c > 127) return;
    const unsigned char* glyph = font8x8_basic[c - 32];
    for (int row = 0; row < 8; row++) {
        for (int col = 0; col < 8; col++) {
            if (glyph[row] & (1 << (7 - col))) {
                fb[(y + row) * fb_width + (x + col)] = color;
            }
        }
    }
}

void draw_string(unsigned int* fb, int fb_width, int x, int y, const char* s, unsigned int color) {
    int orig_x = x;
    while (*s) {
        if (*s == '\n') {
            y += 8; // This assumes each character is 8 pixels tall
            x = orig_x;
        } else {
            draw_char(fb, fb_width, x, y, *s, color);
            x += 8; // This assumes each character is 8 pixels wide
        }
        s++;
    }
}


void framebuffer_context_init(FramebufferContext *fctx) {
    fctx->fb = ctx_get_framebuffer();
    fctx->fb_ptr = (unsigned int*)fctx->fb->address;
    fctx->fb_width = (int)fctx->fb->width;
    fctx->fb_height = (int)fctx->fb->height;
    fctx->char_width = FRAMEBUFFER_LOG_CHAR_WIDTH;
    fctx->char_height = FRAMEBUFFER_LOG_CHAR_HEIGHT;
    fctx->cols = fctx->fb_width / fctx->char_width;
    fctx->rows = fctx->fb_height / fctx->char_height;
    ASSERT(fctx->cols <= MAX_FRAMEBUFFER_COLS);
    ASSERT(fctx->rows <= MAX_FRAMEBUFFER_ROWS);
    for (int r = 0; r < fctx->rows; r++) {
        for (int c = 0; c < fctx->cols; c++) {
            fctx->char_grid[r][c] = ' ';
        }
        fctx->char_grid[r][fctx->cols] = '\0';
        fctx->char_grid_ptrs[r] = fctx->char_grid[r];
        fctx->dirty_rows[r] = 1; // mark all dirty on init
    }
    fctx->cursor_row = 0;
    fctx->cursor_col = 0;
}

static void framebuffer_log_render(FramebufferContext *fctx) {
    for (int r = 0; r < fctx->rows; r++) {
        if (!fctx->dirty_rows[r]) continue;
        int y = r * fctx->char_height;
        // Clear only this row
        for (int row = 0; row < fctx->char_height; row++) {
            for (int col = 0; col < fctx->fb_width; col++) {
                fctx->fb_ptr[(y + row) * fctx->fb_width + col] = 0x000000; // black
            }
        }
        draw_string(fctx->fb_ptr, fctx->fb_width, 0, y, fctx->char_grid_ptrs[r], FONT_COLOR_WHITE);
        fctx->dirty_rows[r] = 0;
    }
}

static void framebuffer_scroll_up(FramebufferContext *fctx) {
    for (int r = 1; r < fctx->rows; r++) {
        for (int c = 0; c < fctx->cols; c++) {
            fctx->char_grid[r-1][c] = fctx->char_grid[r][c];
        }
        fctx->char_grid[r-1][fctx->cols] = '\0';
        fctx->dirty_rows[r-1] = 1;
    }
    for (int c = 0; c < fctx->cols; c++) {
        fctx->char_grid[fctx->rows-1][c] = ' ';
    }
    fctx->char_grid[fctx->rows-1][fctx->cols] = '\0';
    fctx->dirty_rows[fctx->rows-1] = 1;
    fctx->cursor_row = fctx->rows - 1;
}

static void framebuffer_log_putc(FramebufferContext *fctx, char c) {
    if (c == '\n') {
        fctx->cursor_col = 0;
        fctx->cursor_row++;
        if (fctx->cursor_row >= fctx->rows) {
            framebuffer_scroll_up(fctx);
        }
        return;
    }
    if (c == '\r') return;
    if (fctx->cursor_col >= fctx->cols) {
        fctx->cursor_col = 0;
        fctx->cursor_row++;
        if (fctx->cursor_row >= fctx->rows) {
            framebuffer_scroll_up(fctx);
        }
    }
    fctx->char_grid[fctx->cursor_row][fctx->cursor_col] = c;
    fctx->dirty_rows[fctx->cursor_row] = 1;
    fctx->cursor_col++;
}

void framebuffer_log_write_ctx(FramebufferContext *fctx, const char* str, int size) {
    for (int i = 0; i < size; i++) {
        framebuffer_log_putc(fctx, str[i]);
    }
    framebuffer_log_render(fctx);
}

// Legacy global log context for compatibility
static FramebufferContext global_fb_ctx;
void framebuffer_log_init() {
    framebuffer_context_init(&global_fb_ctx);
}
void framebuffer_log_write(const char* str, int size) {
    framebuffer_log_write_ctx(&global_fb_ctx, str, size);
}

